<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8">
  <title>Каталог з Google Sheets: категорії як шапки</title>
  <style>
    body { font-family: sans-serif; background: #f8f8f8; }
    .container { max-width: 980px; margin: auto; background: #fff; padding: 24px; border-radius:10px; }
    .category-block { margin:36px 0 18px; padding-bottom: 6px; border-bottom:2px solid #009688;}
    .category-name { font-size:1.5em; font-weight:600; color:#009688;}
    table { border-collapse: collapse; width:100%; margin-bottom: 14px;}
    th, td { border: 1px solid #ccc; padding: 8px 7px; }
    th { background: #eee;}
    img { width:66px; height:66px; object-fit:cover; border-radius:6px; background:#ececec; }
    input[type="number"] { width: 48px; }
    .cart { margin-top: 38px; background: #def; border-radius:6px; padding:17px; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Каталог з Google Sheets (категорії-блоки)</h2>
    <div id="productList"></div>
    <div class="cart">
      <h3>Кошик</h3>
      <div id="cartList">Порожній</div>
      <div id="cartTotal"></div>
    </div>
  </div>
<script>
const SHEET_ID = '1LKIfZIoC4wrrHBuX7YgcaQ22Xcq5sWNvq4ZlIzY6_VY';  // example: '1AbCDefGhIjK...'
const SHEET_GID = '69860483'; // зазвичай 0 для першого листу
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
let dataRows = [];
let cart = {};

function parseCSV(csv) {
  // Перетворюємо в масив рядків/масивів
  const lines = csv.split('\n').filter(x=>x.trim());
  return lines.map(line => line.split(','));
}

function groupByCategory(rows) {
  let categories = [];
  let cat = null;
  rows.forEach((row, idx) => {
    // Якщо Price/Cena (наприклад, 5-7 стовпець) порожній, і Full_Name/Article не порожні — це категорія
    if ((row[1] || '').trim() && (row[4] || '') === '' && (row[0] || '') === '') {
      cat = {
        name: row[1].trim(),
        items: []
      };
      categories.push(cat);
    } else if (
      cat && 
      (row[1] || '').trim() && // Код товару чи артикул
      (row[6] || '').trim() !== "" // Price
    ) {
      cat.items.push({
        code: row[1],
        name: row[3] || row[2] || '',   // Full_Name або Article
        price: row[6],
        image: row[0],
        stock: row[7] || 100,  // Наприклад, колонка "Stock" якщо є, або дефолт
        idx
      });
    }
  });
  return categories;
}

function renderProducts() {
  let html = '';
  const cats = groupByCategory(dataRows);
  cats.forEach(cat => {
    if (!cat.items.length) return;
    html += `<div class="category-block"><span class="category-name">${cat.name}</span></div>`;
    html += `<table><tr><th>Фото</th><th>Назва</th><th>Ціна</th><th>Додати</th></tr>`;
    html += cat.items.map((prod,i)=>`
      <tr>
        <td>${prod.image?`<img src="${prod.image}" />`:''}</td>
        <td>${prod.name}</td>
        <td>${prod.price}</td>
        <td>
          <input type="number" id="qty_${cat.name}_${i}" min="1" max="${prod.stock}" value="1"/>
          <button onclick="addToCart('${cat.name}',${i})">+</button>
        </td>
      </tr>
    `).join('');
    html += `</table>`;
  });
  document.getElementById('productList').innerHTML = html || 'Немає даних';
}

function addToCart(catName, idx) {
  const cats = groupByCategory(dataRows);
  const cat = cats.find(c=>c.name===catName);
  const prod = cat.items[idx];
  const input = document.getElementById('qty_' + catName + '_' + idx);
  const qty = parseInt(input.value);
  if (!qty || qty < 1) return alert('Невірна кількість');
  const key = `${catName}_${prod.name}`;
  if (!cart[key]) cart[key] = {...prod, quantity: 0};
  cart[key].quantity += qty;
  renderCart();
}
function renderCart() {
  const items = Object.values(cart);
  if (!items.length) {
    document.getElementById('cartList').innerHTML = "Порожній";
    document.getElementById('cartTotal').innerHTML = ""
    return;
  }
  let total = 0;
  let html = `<table><tr><th>Товар</th><th>Кількість</th><th>Ціна</th></tr>`;
  html += items.map(itm => {
    let sum = parseFloat(itm.price)*itm.quantity;
    total += sum;
    return `<tr><td>${itm.name}</td><td>${itm.quantity}</td><td>${sum.toFixed(2)}</td></tr>`;
  }).join('');
  html += `</table>`;
  document.getElementById('cartList').innerHTML = html;
  document.getElementById('cartTotal').innerHTML = `<b>Всього: ${total.toFixed(2)}</b>`;
}

fetch(CSV_URL)
  .then(res=>res.text())
  .then(csv=>{
      dataRows = parseCSV(csv);
      renderProducts();
      cart = {};
      renderCart();
  });

window.addToCart = addToCart;
</script>
</body>
</html>
